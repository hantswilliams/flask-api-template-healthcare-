{% extends "base.html" %}

{% block title %}
    Manage Permissions
{% endblock %}

{% block content %}

    <div class="container mx-auto px-4 py-8">

        <div class="mb-8">
            <h2 class="text-2xl font-bold">Available Endpoints</h2>
            <ul class="list-disc pl-5 mt-3">
                {% for route in routes %}
                <li>{{ route.endpoint }}: {{ route.methods | join(", ") }}</li>
                {% endfor %}
            </ul>
        </div>

        <div class="mb-8">
            <h2 class="text-2xl font-bold">Add New Permission</h2>
            <form id="add-permission-form" class="mt-3">
                <div class="mb-3">
                    Subject: <select name="subject" id="subject-select" class="border-gray-300 rounded-md shadow-sm"></select>
                </div>
                <div class="mb-3">
                    Object: <select name="object" class="border-gray-300 rounded-md shadow-sm">
                        {% for route in routes %}
                        <option value="{{ route.endpoint }}">{{ route.endpoint }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="mb-3">
                    Action: <select name="action" class="border-gray-300 rounded-md shadow-sm">
                        <option value="GET">GET - Read</option>
                        <option value="POST">POST - Create</option>
                        <option value="PUT">PUT - Update</option>
                        <option value="DELETE">DELETE - Delete</option>
                    </select>
                </div>
                <button type="submit" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                    Add Permission
                </button>
            </form>
        </div>

        <div class="mb-8">
            <h2 class="text-2xl font-bold">Existing Permissions</h2>
            <ul id="permissions-list" class="list-disc pl-5 mt-3">
                <!-- Permissions will be dynamically added here -->
            </ul>
        </div>

        <div>
            <h2 class="text-2xl font-bold">Manage Users</h2>
            <form action="/api/users/add" method="POST" class="mt-3">
                <div class="mb-3">
                    Username: <input type="text" name="username" required class="border-gray-300 rounded-md shadow-sm">
                </div>
                <div class="mb-3">
                    Password: <input type="password" name="password" required class="border-gray-300 rounded-md shadow-sm">
                </div>
                <button type="submit" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">
                    Add User
                </button>
            </form>
        </div>

        <div class="mt-8">
            <h3 class="text-xl font-bold">Existing Users</h3>
            <ul>
                {% for user in users %}
                <li class="mt-2">
                    {{ user.username }}
                    <form action="/api/users/delete-user/{{ user.id }}" method="post" class="inline-block ml-4">
                        <button type="submit" class="bg-red-500 hover:bg-red-700 text-white font-bold py-1 px-2 rounded focus:outline-none focus:shadow-outline">Delete</button>
                    </form>
                    <button onclick="editUser('{{ user.id }}')" class="bg-yellow-500 hover:bg-yellow-700 text-white font-bold py-1 px-2 rounded focus:outline-none focus:shadow-outline">Edit Password</button>
                </li>
                {% endfor %}
            </ul>
        </div>



        <div class="mt-10 mb-4 text-left">
            <!-- Profile Button -->
            <div class="mb-4">
                <a href="/profile" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                    Go to Profile
                </a>
            </div>
            <!-- Logout Button -->
            <form action="/logout" method="GET">
                <button type="submit" class="bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded">
                    Logout
                </button>
            </form>
        </div>


    </div>

    <script>
        // Function to fetch and display permissions
        function fetchPermissions() {
            fetch('/api/permissions')
                .then(response => response.json())
                .then(data => {
                    // sort the data by subject
                    data.sort((a, b) => a.subject.localeCompare(b.subject));
                    const list = document.getElementById('permissions-list');
                    list.innerHTML = ''; // Clear existing list content
                    data.forEach(permission => {
                        const item = document.createElement('li');
                        item.classList.add('mb-4', 'flex', 'justify-between', 'items-center', 'bg-gray-100', 'p-4', 'rounded-lg'); // Tailwind classes for the list item
                        item.textContent = `
                            User ID: ${permission.user_id},  
                            Subject: ${permission.subject}, 
                            Object: ${permission.object}, 
                            Action: ${permission.action}
                        `;

                        const editButton = document.createElement('button');
                        editButton.textContent = 'Edit';
                        editButton.classList.add('bg-blue-500', 'hover:bg-blue-700', 'text-white', 'font-bold', 'py-2', 'px-4', 'rounded'); // Tailwind classes for the button
                        // Avoid using permission.id directly in event listener to prevent undefined errors
                        editButton.addEventListener('click', function() {
                            console.log('Edit button clicked for permission: ', permission.id)
                            editPermission(permission.id);
                        });

                        const deleteButton = document.createElement('button');
                        deleteButton.textContent = 'Delete';
                        deleteButton.classList.add('bg-red-500', 'hover:bg-red-700', 'text-white', 'font-bold', 'py-2', 'px-4', 'rounded', 'ml-2'); // Tailwind classes for the button
                        deleteButton.addEventListener('click', function() {
                            deletePermission(permission.id);
                        });

                        // Append buttons to a container div for better control over styling
                        const buttonContainer = document.createElement('div');
                        buttonContainer.classList.add('flex', 'items-center');
                        buttonContainer.appendChild(editButton);
                        buttonContainer.appendChild(deleteButton);

                        // Appending the button container to the item, not directly to keep text styling intact
                        item.appendChild(buttonContainer);

                        // Append the item to the list
                        list.appendChild(item);
                    });
                })
                .catch(error => console.error('Error fetching permissions:', error));
        }

        // Function to fetch and display users
        function fetchUsers() {
            fetch('/api/users')
                .then(response => response.json())
                .then(data => {
                    const select = document.getElementById('subject-select');
                    select.innerHTML = ''; // Clear existing options
                    data.forEach(subject => {
                        const option = document.createElement('option');
                        option.value = subject;
                        option.textContent = subject;
                        select.appendChild(option);
                    });
                })
                .catch(error => console.error('Error fetching users:', error));
        }

        // Call fetchUsers on page load to populate the subjects dropdown
        document.addEventListener('DOMContentLoaded', fetchUsers);

    
        // Function to edit a permission (assumes subject should not be editable based on requirements)
        function editPermission(permissionId) {
            const object = prompt("Enter new object:");
            const action = prompt("Enter new action:");
    
            if (object && action) {
                fetch(`/api/permissions/${permissionId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({object, action}),
                })
                .then(response => {
                    if (response.ok) {
                        fetchPermissions(); // Refresh the permissions list upon successful update
                    } else {
                        alert('Error updating permission');
                    }
                })
                .catch(error => console.error('Error updating permission:', error));
            }
        }
    
        // Function to delete a permission
        function deletePermission(permissionId) {
            if (confirm("Are you sure you want to delete this permission?")) {
                fetch(`/api/permissions/${permissionId}`, {
                    method: 'DELETE',
                })
                .then(response => {
                    if (response.ok) {
                        fetchPermissions(); // Refresh the permissions list upon successful deletion
                    } else {
                        alert('Error deleting permission');
                    }
                })
                .catch(error => console.error('Error deleting permission:', error));
            }
        }
    
        // Add a new permission via POST request
        document.getElementById('add-permission-form').addEventListener('submit', function(e) {
            e.preventDefault(); // Prevent default form submission behavior
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());
    
            fetch('/api/permissions/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data),
            })
            .then(response => {
                if (response.ok) {
                    fetchPermissions(); // Refresh the permissions list upon successful addition
                } else {
                    alert('Error adding permission');
                }
            })
            .catch(error => console.error('Error posting permission:', error));
        });
    
        // Fetch and display existing permissions when the page loads
        document.addEventListener('DOMContentLoaded', fetchPermissions);


        function editUser(userId) {
            const newPassword = prompt("Enter new password for user:");
            if (newPassword) {
                // Assuming you have a hidden form for editing user passwords
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = `/api/users/edit-user/${userId}`;

                const newPasswordInput = document.createElement('input');
                newPasswordInput.type = 'hidden';
                newPasswordInput.name = 'new_password';
                newPasswordInput.value = newPassword;
                
                form.appendChild(newPasswordInput);
                document.body.appendChild(form);
                form.submit();
            }
        }

    </script>
    
{% endblock %}
